<?php

/**
 * Wysiwyg Widget tests.
 *
 * @group wysiwyg_widget
 */
class WysiwygWidgetTest extends DrupalWebTestCase {
  protected $profile = 'standard';

  /**
   * Modules to enable.
   *
   * @var array
   */
  public $modules = array(
    'wysiwyg_widget',
  );

  /**
   * @var object
   */
  protected $adminUser;

  /**
   * Info.
   *
   * @return array
   *   The test info
   */
  public static function getInfo() {
    return array(
      'name' => 'Wysiwyg Widget',
      'description' => 'Tests for Wysiwyg Widget.',
      'group' => 'Wysiwyg Widget',
    );
  }

  /**
   * Setup.
   */
  public function setUp() {
    parent::setUp($this->modules);

    // Create admin user.
    $this->adminUser = $this->drupalCreateUser(array(
      'access administration pages',
      'administer site configuration',
      'administer modules',
      'create article content',
      'edit own article content',
      'administer filters',
    ));

    $this->drupalLogin($this->adminUser);
  }

  /**
   * Modules page.
   */
  function testLinkToConfig() {
    $this->drupalGet('admin/modules');
    $link = $this->xpath('//a[contains(@href, :href) and contains(@id, :id)]', [
      ':href' => 'admin/structure/wysiwyg_widget/settings',
      ':id' => 'edit-modules-user-interface-wysiwyg-widget-links-configure'
    ]);
    $this->assertTrue(count($link) === 1, 'Link to config is present');
  }

  /**
   * Admin UI.
   */
  function testAdminUI() {
    // Configure input filters.
    $this->drupalGet('admin/config/content/formats/full_html');

    // Select newly created role and the widget embed plugin.
    $filters = array(
      'filters[widget_embed][status]' => 1,
      'roles[4]' => 4,
    );
    $this->drupalPost(NULL, $filters, t('Save configuration'));

    // Configure XSS header.
    $this->drupalGet('admin/structure/wysiwyg_widget/settings');
    $this->assertRaw('Send X-XSS-Protection header');

    $config = array(
      'wysiwyg_widget_xss_header' => 1,
    );
    $this->drupalPost(NULL, $config, t('Save configuration'));

    // Add a new widget.
    $this->drupalGet('admin');
    $this->clickLink('Structure');
    $this->clickLink('Wysiwyg Widget');
    $this->clickLink('Add');

    $widget = array(
      'name' => 'Twitter single tweet',
      'pattern' => 'twitter-tweet',
      'flags' => 'gi',
      'external_js' => 'https://platform.twitter.com/widgets.js',
      'external_js_async' => TRUE,
    );
    $this->drupalPost(NULL, $widget, t('Save'));

    // Create node with Twitter embed.

    /* This is the plain code that will get encoded by the plugin as you can see below.
    '<div class="wysiwyg-widget-wrapper">
      <blockquote class="twitter-tweet" data-lang="en">
        <a href="https://twitter.com/FIFAWorldCup/status/1013877667307884544?ref_src=twsrc%5Etfw">July 2, 2018</a>
      </blockquote>
    </div>';
    */

    // Inserting the encoded value.
    $markup = '<!--widget_embed:%3Cdiv%20class%3D%22wysiwyg-widget-wrapper%22%3E%3Cblockquote%20class%3D%22twitter-tweet%22%20data-lang%3D%22en%22%3E%0A%3Ca%20href%3D%22https%3A//twitter.com/FIFAWorldCup/status/1013877667307884544%3Fref_src%3Dtwsrc%255Etfw%22%3EJuly%202%2C%202018%3C/a%3E%0A%3C/blockquote%3E%0A%0A%3C/div%3E-->';
    $node = $this->createNode($markup);

    // Check the node.
    $this->drupalGet('node/' . $node->nid);
    $this->assertText($node->title);
    $this->assertRaw('<div class="wysiwyg-widget-wrapper"><blockquote class="twitter-tweet"');
    $this->assertRaw('<a href="https://twitter.com/FIFAWorldCup/status/1013877667307884544');
    $this->assertRaw('src="https://platform.twitter.com/widgets.js"');

    $this->drupalGet('node/' . $node->nid . '/edit');
  }

  /**
   * Creates nodes for testing.
   *
   * @param string $markup
   *   Create the node with media markup in the body field
   *
   * @return object
   *   Returns the node
   */
  protected function createNode($markup = '') {
    // Create an article node with file markup in the body field.
    $edit = array(
      'title' => $this->randomName(8),
      'body[und][0][value]' => $markup,
      'body[und][0][format]' => 'full_html',
    );
    $this->drupalPost('node/add/article', $edit, t('Save'));

    // Get the article node that was saved by the unique title.
    $node = $this->drupalGetNodeByTitle($edit['title']);

    return $node;
  }

}
